---
title: Использование TeamCity с Xamarin
description: В этом руководстве рассматриваются шаги, связанные с использованием TeamCity для компиляции мобильных приложений, а затем их отправка в тест в центре приложений.
ms.prod: xamarin
ms.assetid: AC2626CB-28A7-4808-B2A9-789D67899546
author: davidortinau
ms.author: daortin
ms.date: 04/01/2020
ms.openlocfilehash: 553f40a407fa8003a6545214a545f00b01fb0ed6
ms.sourcegitcommit: b75c369adb8e02a429b6c0fed8ba4a855099bf01
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/18/2021
ms.locfileid: "98555039"
---
# <a name="using-teamcity-with-xamarin"></a>Использование TeamCity с Xamarin

_В этом руководстве рассматриваются шаги, связанные с использованием TeamCity для компиляции мобильных приложений, а затем их отправка в тест в центре приложений._

Как уже говорилось в статье [Введение в непрерывную интеграцию](~/tools/ci/intro-to-ci.md) , непрерывная интеграция (CI) является полезной практикой при разработке мобильных приложений. Существует множество вариантов для серверного программного обеспечения непрерывной интеграции. в этом руководством основное внимание уделяется [TeamCity](https://www.jetbrains.com/teamcity/) от JetBrains.

Существует несколько различных перестановок установки TeamCity. В следующем списке описаны некоторые из этих перестановок.

- **Служба Windows** — в этом сценарии TeamCity запускается при загрузке Windows в качестве службы Windows. Он должен быть связан с узлом сборки Mac для компиляции любых приложений iOS.

- **Запустить управляющую программу в OS X** — концептуально это похоже на работу в качестве службы Windows, описанной на предыдущем шаге. По умолчанию сборки будут выполняться с учетной записью root.

- **Учетная запись пользователя в OS X** — можно запустить TeamCity под учетной записью пользователя, которая запускается каждый раз при входе пользователя в систему.

Из предыдущих сценариев запуск TeamCity под учетной записью пользователя в OS X является самым простым и простым в установке.

Существует несколько шагов, связанных с настройкой TeamCity:

- **Установка TeamCity** — установка TeamCity не рассматривается в этом руководство. В этом учебнике предполагается, что TeamCity установлен и работает под учетной записью пользователя. Инструкции по [установке TeamCity](https://confluence.jetbrains.com/display/TCD8/Installation) можно найти в документации по [TeamCity 8](https://confluence.jetbrains.com/display/TCD8/TeamCity+Documentation) с помощью JetBrains.

- **Подготовка сервера сборки** . Этот шаг включает установку необходимого программного обеспечения, средств и сертификатов, необходимых для создания мобильных приложений и подготовки их к распространению.

- **Создание скрипта сборки** — этот шаг не является обязательным, но скрипт сборки полезен для автоматического создания приложений. Использование скрипта сборки поможет в устранении неполадок, возникающих при сборке, и предоставляет согласованный, повторяемый способ создания двоичных файлов для распространения, даже если непрерывная интеграция не выполняется.

- **Создание проекта TeamCity** . После выполнения предыдущих трех шагов необходимо создать проект TeamCity, который будет содержать все метаданные, необходимые для получения исходного кода, скомпилировать проекты и отправить тесты в тест App Center.

## <a name="requirements"></a>Требования

Требуется опыт работы с [тестом App Center](/appcenter/test-cloud/) .

Знание TeamCity 8,1 является обязательным. Установка TeamCity выходит за рамки данного документа. Предполагается, что TeamCity установлен в OS X Mavericks и выполняется под обычной учетной записью пользователя, а не с учетной записью root.

Сервер сборки должен быть автономным компьютером под управлением OS X, предназначенным для непрерывной интеграции. В идеале сервер сборки не несет ответственности за любые другие роли, такие как сервер базы данных, веб-сервер или рабочая станция разработчика.

> [!IMPORTANT]
> В этом руководства не рассматривается установка Xamarin без монитора.

[!include[](~/tools/ci/includes/firewall-information.md)]

## <a name="preparing-the-build-server"></a>Подготовка сервера сборки

Важным шагом при настройке сервера сборки является установка всех необходимых средств, программного обеспечения и сертификатов для создания мобильных приложений. Важно, чтобы сервер сборки мог компилировать мобильное решение и выполнять любые тесты. Чтобы избежать проблем с конфигурацией, программное обеспечение и средства должны быть установлены в той же учетной записи пользователя, где размещается TeamCity. Ниже приведен список необходимых сведений.

1. **Visual Studio для Mac** — это включает Xamarin. iOS и Xamarin. Android.
2. **Войдите в хранилище компонентов Xamarin** — этот шаг является необязательным и необходим только в том случае, если приложение использует компоненты из хранилища компонентов Xamarin. Упреждающий вход в хранилище компонентов на этом этапе предотвратит любые проблемы, когда сборка TeamCity пытается скомпилировать приложение.
3. **Xcode** – Xcode требуется для компиляции и подписывания приложений iOS.
4. **Xcode Command-Line Tools** — это описано на шаге 1 раздела Установка [обновления Ruby with rbenv](https://github.com/calabash/calabash-ios/wiki) .
5. **Удостоверение подписывания & профили подготовки** — импортируйте сертификаты и профиль подготовки через Xcode. Дополнительные сведения см. в статье Apple Guide об [экспорте удостоверений подписывания и профилей подготовки](https://developer.apple.com/library/ios/recipes/xcode_help-accounts_preferences/articles/export_signing_assets.html) .
6. **Хранилища ключей Android** — скопируйте необходимые хранилища ключей Android в каталог, к которому пользователь TeamCity имеет доступ, например `~/Documents/keystores/MyAndroidApp1` .
7. **Calabash** — это необязательный шаг, если приложение содержит тесты, написанные с помощью Calabash. Дополнительные сведения см. в статье [об установке Calabash в OS X Mavericks](https://github.com/calabash/calabash-ios/wiki) и в разделе [Обновление Ruby with rbenv](https://github.com/calabash/calabash-ios/wiki) .

На следующей схеме показаны все эти компоненты.

![На этой схеме показаны все эти компоненты](teamcity-images/image1.png)

После установки всех программ Войдите в учетную запись пользователя и убедитесь, что все программное обеспечение правильно установлено и работает. Это должно привести к компиляции решения и отправке приложения в тест App Center. Это можно упростить, запустив скрипт сборки, как описано в следующем разделе.

## <a name="create-a-build-script"></a>Создание скрипта сборки

Несмотря на то, что TeamCity может выполнять все аспекты компиляции и отправки мобильных приложений в центр приложений по отдельности; рекомендуется создать скрипт сборки. Скрипт сборки предоставляет следующие преимущества.

1. **Документация** . сценарий сборки служит формой документации о том, как создается программное обеспечение. Это удаляет часть «волшебия», связанную с развертыванием приложения, и позволяет разработчикам сосредоточиться на функциональности.
1. **Повторяемость** — сценарий сборки гарантирует, что каждый раз при компиляции и развертывании приложения оно выполняется таким же образом независимо от того, кто или что выполняет эту работу. Эта Неповторяемая согласованность устраняет все проблемы или ошибки, которые могут возникнуть из-за неверно выполненной сборки или ошибки пользователя.
1. **Управление версиями** — скрипт сборки может быть добавлен в систему управления версиями. Это означает, что изменения в скрипте сборки могут отслеживаться, отслеживаться и исправляться при обнаружении ошибок или неточностей.
1. **Подготовка среды** . скрипт сборки может включать логику для установки необходимых сторонних зависимостей. Это обеспечит построение приложений с использованием соответствующих компонентов.

Скрипт сборки может быть простым, например, файлом PowerShell (в Windows) или сценарием bash (в OS X). При создании скрипта сборки существует несколько вариантов для языков сценариев:

- [**Rake**](https://github.com/jimweirich/rake) — это язык Domain-Specific (DSL) для создания проектов на основе Ruby. Rake обладает преимуществом популярности и обширной экосистемой библиотек.

- [**psake**](https://github.com/psake/psake) — это библиотека Windows PowerShell для создания программного обеспечения

- [**Имитация**](https://fsharp.github.io/FAKE/) — это DSL на основе языка F #, которое позволяет использовать существующие библиотеки .NET, если это необходимо.

Использование языка сценариев зависит от ваших предпочтений и требований.

> [!NOTE]
> Можно использовать систему сборки на основе XML, такую как MSBuild или NAnt, но у них нет выразительных и обслуживаемых языков DSL, предназначенных для создания программного обеспечения.

### <a name="parameterizing-the-build-script"></a>Параметризация скрипта сборки

Для процесса создания и тестирования программного обеспечения требуются сведения, которые должны храниться в секрете. Для создания APK может потребоваться пароль для хранилища ключей и (или) псевдонима ключа в хранилище ключей. Аналогично тесту App Center требуется [ключ API](/appcenter/api-docs/) , уникальный для разработчика. Эти типы значений не должны быть жестко запрограммированы в скрипте сборки. Вместо этого они должны передаваться в качестве переменных в скрипт сборки.

Менее конфиденциальными являются такие значения, как идентификатор устройства iOS или идентификатор устройства Android, которые определяют, какие устройства центр приложений должен использовать для тестовых запусков. Эти значения не должны быть защищены, но могут изменяться от сборки к сборке.

Хранение этих типов переменных за пределами скрипта сборки также упрощает совместное использование скрипта сборки в Организации с примером использования разработчиками. Разработчики могут использовать тот же сценарий, что и сервер сборки, но могут использовать собственные хранилища ключей и [ключи API](/appcenter/api-docs/).

Существует два возможных варианта хранения этих конфиденциальных значений:

- **Файл конфигурации** — для защиты [ключа API](/appcenter/api-docs/) это значение не должно быть возвращено в систему управления версиями. Файл может быть создан для каждого компьютера. Метод считывания значений из этого файла зависит от используемого языка сценариев.

- **Переменные среды** — они могут быть легко заданы для отдельных компьютеров и не зависят от базового языка сценариев.

Каждый из этих вариантов имеет свои преимущества и недостатки. TeamCity хорошо работает с переменными среды, поэтому в этом разделе мы советуем использовать этот метод при создании скриптов сборки.

### <a name="build-steps"></a>Этапы сборки

Скрипт сборки должен выполнять следующие действия:

- **Скомпилируйте приложение** — включает в себя подпись приложения с правильным профилем подготовки.

- **Отправьте приложение в Xamarin Test Cloud** — это включает в себя подписывание и отправку ZIP-файла apk с соответствующим хранилищем ключей.

Эти два действия будут более подробно описаны ниже.

#### <a name="compiling-a-xamarinios-application"></a>Компиляция приложения Xamarin. iOS

[!include[](~/tools/ci/includes/commandline-compile-of-xamarin-ios-ipa.md)]

#### <a name="compiling-a-xamarinandroid-application"></a>Компиляция приложения Xamarin. Android

Чтобы скомпилировать приложение Android, используйте **Xbuild** (или **MSBuild** в Windows):

```bash
/Library/Frameworks/Mono.framework/Commands/xbuild /t:SignAndroidPackage /p:Configuration=Release /path/to/android.csproj
```
При компиляции приложения Android **Xbuild** использует проект, а приложение iOS **Xbuild** использует решение.

#### <a name="submitting-xamarinuitests-to-app-center"></a>Отправка Xamarin. тестов пользовательского интерфейса в центр приложений

Тестов пользовательского интерфейса отправляются с помощью [интерфейса командной строки центра приложений](https://github.com/microsoft/appcenter-cli), как показано в следующем фрагменте кода:

```bash
appcenter test run uitest --app <TEAM-NAME/APP-NAME> --devices <DEVICE_SET> --token <API_KEY> --app-path <appname.APK-or-appname.IPA> --merge-nunit-xml report.xml --build-dir pathToUITestBuildDir
```

При выполнении теста результаты теста будут возвращены в виде XML-файла стиля NUnit с именем **report.xml**. TeamCity будет отображать сведения в журнале сборки.

Дополнительные сведения о том, как отправить тестов пользовательского интерфейса в центр приложений, см. в статье [Подготовка приложений Xamarin. Android](/appcenter/test-cloud/uitest/preparing-for-upload-android) или [Подготовка приложений Xamarin. iOS](/appcenter/test-cloud/uitest/preparing-for-upload-ios).

#### <a name="submitting-calabash-tests-to-app-center"></a>Отправка тестов Calabash в центр приложений

Тесты Calabash отправляются с помощью [интерфейса командной строки центра приложений](https://github.com/microsoft/appcenter-cli), как показано в следующем фрагменте кода:

```bash
appcenter test run calabash --app <TEAM-NAME/APP-NAME> --devices <DEVICE_SET> --token <API_KEY> --app-path <appname.APK-or-appname.IPA> --project-dir pathToProjectDir
```

Чтобы отправить приложение Android в тест App Center, необходимо сначала перестроить тестовый сервер APK с помощью Calabash-Android:

```bash
$ calabash-android build </path/to/signed/APK>
$ appcenter test run calabash --app <TEAM-NAME/APP-NAME> --devices <DEVICE_SET> --token <API_KEY> --app-path <appname.APK> --project-dir pathToProjectDir
```

Дополнительные сведения о отправке тестов Calabash см. в документации по Xamarin, посвященной [отправке тестов Calabash в Test Cloud](https://github.com/calabash/calabash-ios/wiki).

## <a name="creating-a-teamcity-project"></a>Создание проекта TeamCity

После установки TeamCity и Visual Studio для Mac может выполнить сборку проекта, пора создать проект в TeamCity для сборки проекта и отправки его в центр приложений.

1. Для начала Войдите в TeamCity через веб-браузер. Перейдите к корневому проекту:

    ![Переход к корневому проекту](teamcity-images/image2.png "Переход к корневому проекту") Под корневым проектом создайте новый подпроект:

    ![Перейдите к корневому проекту под корневым проектом, создайте новый подпроект](teamcity-images/image3.png "Перейдите к корневому проекту под корневым проектом и создайте новый подпроект")
2. После создания подпроекта добавьте новую конфигурацию сборки:

    ![После создания подпроекта добавьте новую конфигурацию сборки.](teamcity-images/image5.png "После создания подпроекта добавьте новую конфигурацию сборки.")
3. Присоедините проект VCS к конфигурации сборки. Это делается с помощью экрана настройки системы управления версиями:

    ![Это делается с помощью экрана настройки системы управления версиями.](teamcity-images/image6.png "Это делается с помощью экрана настройки системы управления версиями.")

    Если проект VCS не создан, его можно создать на странице новой корневой папки VCS, как показано ниже.

    ![Если проект VCS не создан, его можно создать на странице «Новая корневая папка VCS».](teamcity-images/image7.png "Если проект VCS не создан, вы можете создать его на странице "Новая корневая папка VCS".")

    После подключения корневого каталога VCS TeamCity выполнит извлечение проекта и попытается автоматически обнаружить шаги сборки. Если вы знакомы с TeamCity, то можете выбрать один из обнаруженных шагов сборки. Теперь можно спокойно игнорировать обнаруженные шаги сборки.

4. Затем настройте триггер сборки. При выполнении определенных условий это приведет к постановке сборки в очередь, например, когда пользователь фиксирует код в репозитории. На следующем снимке экрана показано, как добавить триггер сборки:

    ![На этом снимке экрана показано, как добавить триггер сборки](teamcity-images/image8.png "На этом снимке экрана показано, как добавить триггер сборки") Пример настройки триггера сборки можно увидеть на следующем снимке экрана:

    ![Пример настройки триггера сборки можно увидеть на этом снимке экрана](teamcity-images/image9.png "Пример настройки триггера сборки можно увидеть на этом снимке экрана")

5. В предыдущем разделе параметризация скрипта сборки было предложено сохранить некоторые значения в виде переменных среды. Эти переменные можно добавить в конфигурацию сборки с помощью экрана "Параметры". Добавьте переменные для [ключа API](/appcenter/api-docs/)центра приложений, идентификатор устройства iOS и идентификатор устройства Android, как показано на снимке экрана ниже:

    ![Добавьте переменные для ключа API тестирования центра приложений, идентификатор устройства iOS и идентификатор устройства Android.](teamcity-images/image11.png "Добавьте переменные для ключа API Test Cloud, идентификатора устройства iOS и идентификатора устройства Android.")

6. Последним шагом является добавление шага сборки, который будет вызывать скрипт сборки для компиляции приложения и постановки приложения в очередь для теста App Center. На следующем снимке экрана показан пример шага сборки, который использует Ракефиле для создания приложения:

    ![На этом снимке экрана показан пример этапа сборки, который использует Ракефиле для создания приложения.](teamcity-images/image12.png "На этом снимке экрана показан пример этапа сборки, который использует Ракефиле для создания приложения.")

7. На этом этапе Конфигурация сборки завершена. Рекомендуется активировать сборку, чтобы убедиться, что проект настроен правильно. Для этого лучше всего зафиксировать незначительные изменения в репозитории. TeamCity должен обнаружить фиксацию и запустить сборку.

8. После завершения сборки проверьте журнал сборки и проверьте наличие проблем или предупреждений в сборке, требующих внимания.

## <a name="summary"></a>Сводка

В этом руководство описано, как использовать TeamCity для создания мобильных приложений Xamarin и их отправки в тест App Center. Мы обсуждали создание скрипта сборки для автоматизации процесса сборки. Скрипт сборки отвечает за компиляцию приложения, отправку в тест App Center и ожидание результатов.

Затем мы рассмотрели создание проекта в TeamCity, который будет ставить сборку в очередь каждый раз, когда разработчик фиксирует код и вызовет скрипт сборки.

## <a name="related-links"></a>Связанные ссылки

- [Подготовка приложений Xamarin. Android](/appcenter/test-cloud/uitest/preparing-for-upload-android)
- [Подготовка приложений Xamarin. iOS](/appcenter/test-cloud/uitest/preparing-for-upload-ios)
- [Установка и настройка TeamCity](https://confluence.jetbrains.com/display/TCD8/Installing+and+Configuring+the+TeamCity+Server)
