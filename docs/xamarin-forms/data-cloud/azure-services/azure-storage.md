---
title: Хранение данных в службе хранилища Azure и доступ к ним из Xamarin.Forms
description: Служба хранилища Azure — это решение масштабируемого облачного хранилища, которое можно использовать для хранения неструктурированных и структурированных данных. В этой статье объясняется, как использовать Xamarin.Forms для хранения текстовых и двоичных данных в службе хранилища Azure, а также как получить доступ к данным.
ms.prod: xamarin
ms.assetid: 5B10D37B-839B-4CD0-9C65-91014A93F3EB
ms.technology: xamarin-forms
author: davidbritch
ms.author: dabritch
ms.date: 12/28/2018
no-loc:
- Xamarin.Forms
- Xamarin.Essentials
ms.openlocfilehash: bd726a5e5d6064ecb9aa1c862697e08a9c4733f4
ms.sourcegitcommit: ebdc016b3ec0b06915170d0cbbd9e0e2469763b9
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/05/2020
ms.locfileid: "93370121"
---
# <a name="store-and-access-data-in-azure-storage-from-no-locxamarinforms"></a>Хранение данных в службе хранилища Azure и доступ к ним из Xamarin.Forms

[![Загрузить образец](~/media/shared/download.png) загрузить пример](/samples/xamarin/xamarin-forms-samples/webservices-azurestorage)

_Служба хранилища Azure — это решение масштабируемого облачного хранилища, которое можно использовать для хранения неструктурированных и структурированных данных. В этой статье показано, как использовать Xamarin.Forms для хранения текстовых и двоичных данных в службе хранилища Azure, а также как получить доступ к данным._

Служба хранилища Azure предоставляет четыре службы хранения:

- Хранилище BLOB-объектов. BLOB-объект может представлять собой текстовые или двоичные данные, такие как резервные копии, виртуальные машины, файлы мультимедиа или документы.
- Хранилище таблиц — это NoSQL хранилище атрибутов ключей.
- Хранилище очередей — это служба обмена сообщениями для обработки рабочих процессов и взаимодействия между облачными службами.
- Хранилище файлов предоставляет общее хранилище с использованием протокола SMB.

Существует два типа учетных записей хранения:

- Учетные записи хранения общего назначения предоставляют доступ к службам хранилища Azure из одной учетной записи.
- Учетная запись хранения BLOB-объектов — это специализированная учетная запись хранения для хранения больших двоичных объектов. Этот тип учетной записи рекомендуется использовать, если требуется хранить только данные большого двоичного объекта.

В этой статье и прилагаемом к ней образце приложения демонстрируется передача файлов изображений и текстов в хранилище BLOB-объектов и их загрузка. Кроме того, здесь демонстрируется получение списка файлов из хранилища BLOB-объектов и удаление файлов.

Дополнительные сведения о службе хранилища Azure см. [в статье Введение в хранилище](https://azure.microsoft.com/documentation/articles/storage-introduction/).

> [!NOTE]
> Если у вас еще нет [подписки Azure](/azure/guides/developer/azure-developer-guide#understanding-accounts-subscriptions-and-billing), создайте [бесплатную учетную запись Azure](https://aka.ms/azfree-docs-mobileapps), прежде чем начать работу.

## <a name="introduction-to-blob-storage"></a>Общие сведения о хранилище BLOB-объектов

Хранилище BLOB-объектов состоит из трех компонентов, которые показаны на следующей схеме:

![Основные понятия хранилища BLOB-объектов](azure-storage-images/blob-storage.png)

Все доступ к службе хранилища Azure осуществляется через учетную запись хранения. Учетная запись хранения может содержать неограниченное количество контейнеров, а контейнер может хранить неограниченное количество больших двоичных объектов, вплоть до ограничения емкости учетной записи хранения.

Большой двоичный объект — это файл любого типа и размера. Служба хранилища Azure поддерживает три разных типа больших двоичных объектов:

- Блочные BLOB-объекты оптимизированы для потоковой передачи и хранения облачных объектов. они хорошо подходят для хранения резервных копий, файлов мультимедиа, документов и т. д. Размер блочных BLOB-объектов может доставлять до 195 ГБ.
- Добавочные BLOB-объекты похожи на блочные BLOB-объекты, но оптимизированы для операций добавления, таких как ведение журнала. Добавочные большие двоичные объекты могут иметь размер до 195 ГБ.
- Страничные BLOB-объекты оптимизированы для часто выполняемых операций чтения и записи и обычно используются для хранения виртуальных машин и их дисков. Страничные BLOB-объекты могут иметь размер до 1 ТБ.

> [!NOTE]
> Обратите внимание, что учетные записи хранения BLOB-объектов поддерживают блокировку и Добавление больших двоичных объектов, но не страничных BLOB

Большой двоичный объект отправляется в службу хранилища Azure и загружается из службы хранилища Azure в виде потока байтов. Поэтому файлы должны быть преобразованы в поток байтов перед отправкой и преобразованы обратно в исходное представление после загрузки.

Каждый объект, хранящийся в службе хранилища Azure, имеет уникальный URL-адрес. Имя учетной записи хранения образует поддомен этого адреса, а сочетание поддомена и доменного имени образует *конечную точку* для учетной записи хранения. Например, если ваша учетная запись хранения называется *mystorageaccount* , конечной точкой BLOB-объекта по умолчанию для учетной записи хранения будет `https://mystorageaccount.blob.core.windows.net` .

URL-адрес для доступа к объекту в учетной записи хранения строится путем добавления местоположения объекта в учетной записи хранения к конечной точке. Например, адрес большого двоичного объекта будет иметь формат `https://mystorageaccount.blob.core.windows.net/mycontainer/myblob` .

## <a name="setup"></a>Настройка

Процесс интеграции учетной записи хранения Azure в Xamarin.Forms приложение выглядит следующим образом:

1. Создайте учетную запись хранения. Дополнительные сведения см. в разделе [Создание учетной записи хранения](/azure/storage/common/storage-account-create#create-a-storage-account).
1. Добавьте [клиентскую библиотеку службы хранилища Azure](https://www.nuget.org/packages/WindowsAzure.Storage/) в Xamarin.Forms приложение.
1. Настройте строку подключения к хранилищу. Дополнительные сведения см. [в статье подключение к службе хранилища Azure](#connecting-to-azure-storage).
1. Добавьте `using` директивы для `Microsoft.WindowsAzure.Storage` `Microsoft.WindowsAzure.Storage.Blob` пространств имен и в классы, которые будут обращаться к службе хранилища Azure.

## <a name="connecting-to-azure-storage"></a>Подключение к службе хранилища Azure

Все запросы к ресурсам учетной записи хранения должны пройти проверку подлинности. Хотя большие двоичные объекты можно настроить для поддержки анонимной проверки подлинности, существует два основных подхода, которые приложение может использовать для проверки подлинности с помощью учетной записи хранения:

- Общий ключ. Этот подход использует имя учетной записи хранения Azure и ключ учетной записи для доступа к службам хранилища. Учетной записи хранения назначаются два закрытых ключа при создании, которые можно использовать для проверки подлинности с помощью общего ключа.
- Подпись общего доступа. Это маркер, который можно добавить к URL-адресу, который обеспечивает делегированный доступ к ресурсу хранилища с разрешениями, которые он указывает, за период времени, в течение которого он является допустимым.

Можно указать строки подключения, которые содержат сведения для проверки подлинности, необходимые для доступа к ресурсам службы хранилища Azure из приложения. Кроме того, строку подключения можно настроить для подключения к эмулятору хранения Azure из Visual Studio.

> [!NOTE]
> Служба хранилища Azure поддерживает протоколы HTTP и HTTPS в строке подключения. Однако рекомендуется использовать протокол HTTPS.

### <a name="connecting-to-the-azure-storage-emulator"></a>Подключение к эмулятору хранения Azure

Эмулятор хранения Azure предоставляет локальную среду, которая имитирует службы BLOB-объектов, очередей и таблиц Azure для целей разработки.

Для подключения к эмулятору хранения Azure следует использовать следующую строку подключения:

```csharp
UseDevelopmentStorage=true
```

Дополнительные сведения о эмуляторе хранения Azure см. в статье [использование эмулятора хранения Azure для разработки и тестирования](/azure/storage/common/storage-use-emulator).

### <a name="connecting-to-azure-storage-using-a-shared-key"></a>Подключение к хранилищу Azure с помощью общего ключа

Для подключения к хранилищу Azure с помощью общего ключа следует использовать следующий формат строки подключения:

```csharp
DefaultEndpointsProtocol=[http|https];AccountName=myAccountName;AccountKey=myAccountKey
```

`myAccountName` следует заменить именем вашей учетной записи хранения и `myAccountKey` заменить одним из двух ключей доступа к учетной записи.

> [!NOTE]
> При использовании проверки подлинности с общим ключом имя учетной записи и ключ учетной записи будут распространяться для каждого пользователя, использующего ваше приложение, которое предоставит полный доступ на чтение и запись к учетной записи хранения. Поэтому используйте проверку подлинности с использованием общего ключа только для целей тестирования и никогда не распространяйте ключи другим пользователям.

### <a name="connecting-to-azure-storage-using-a-shared-access-signature"></a>Подключение к хранилищу Azure с помощью подписанного URL-доступа

Для подключения к службе хранилища Azure с помощью SAS следует использовать следующий формат строки подключения:

`BlobEndpoint=myBlobEndpoint;SharedAccessSignature=mySharedAccessSignature`

`myBlobEndpoint` необходимо заменить URL-адресом конечной точки большого двоичного объекта и `mySharedAccessSignature` заменить его на SAS. SAS предоставляет протокол, конечную точку службы и учетные данные для доступа к ресурсу.

> [!NOTE]
> Для рабочих приложений рекомендуется использовать проверку подлинности SAS. Однако в рабочем приложении следует получать SAS из серверной службы по требованию, а не объединяя его с приложением.

Дополнительные сведения о подписанных URL-адресах см. [в разделе использование подписанных URL (SAS)](/azure/storage/common/storage-sas-overview).

## <a name="creating-a-container"></a>Создание контейнера

`GetContainer`Метод используется для получения ссылки на именованный контейнер, который затем можно использовать для получения больших двоичных объектов из контейнера или для добавления больших двоичных объектов в контейнер. Метод `GetContainer` показан в следующем примере кода:

```csharp
static CloudBlobContainer GetContainer(ContainerType containerType)
{
  var account = CloudStorageAccount.Parse(Constants.StorageConnection);
  var client = account.CreateCloudBlobClient();
  return client.GetContainerReference(containerType.ToString().ToLower());
}
```

`CloudStorageAccount.Parse`Метод анализирует строку подключения и возвращает `CloudStorageAccount` экземпляр, представляющий учетную запись хранения. `CloudBlobClient`Экземпляр, который используется для извлечения контейнеров и больших двоичных объектов, затем создается `CreateCloudBlobClient` методом. `GetContainerReference`Метод получает указанный контейнер в качестве `CloudBlobContainer` экземпляра перед его возвратом вызывающему методу. В этом примере имя контейнера является `ContainerType` значением перечисления, преобразованным в строку нижнего регистра.

> [!NOTE]
> Имена контейнеров должны быть строчными и должны начинаться с буквы или цифры. Кроме того, они могут содержать только буквы, цифры и дефисы и должны иметь длину от 3 до 63 символов.

`GetContainer`Метод вызывается следующим образом:

```csharp
var container = GetContainer(containerType);
```

`CloudBlobContainer`Экземпляр можно использовать для создания контейнера, если он еще не существует:

```csharp
await container.CreateIfNotExistsAsync();
```

По умолчанию только что созданный контейнер является частным. Это означает, что для получения больших двоичных объектов из контейнера необходимо указать ключ доступа к хранилищу. Сведения о том, как сделать большие двоичные объекты в контейнере общедоступными, см. в разделе [Создание контейнера](/azure/storage/blobs/storage-quickstart-blobs-dotnet#create-a-container).

## <a name="uploading-data-to-a-container"></a>Отправка данных в контейнер

`UploadFileAsync`Метод используется для передачи потока байтовых данных в хранилище BLOB-объектов и показан в следующем примере кода:

```csharp
public static async Task<string> UploadFileAsync(ContainerType containerType, Stream stream)
{
  var container = GetContainer(containerType);
  await container.CreateIfNotExistsAsync();

  var name = Guid.NewGuid().ToString();
  var fileBlob = container.GetBlockBlobReference(name);
  await fileBlob.UploadFromStreamAsync(stream);

  return name;
}
```

После получения ссылки на контейнер метод создает контейнер, если он еще не существует. `Guid`Затем создается новый объект, который будет использоваться в качестве уникального имени большого двоичного объекта, а ссылка на блок большого двоичного объекта извлекается как `CloudBlockBlob` экземпляр. Поток данных затем отправляется в большой двоичный объект с помощью `UploadFromStreamAsync` метода, который создает большой двоичный объект, если он еще не существует, или перезаписывает его, если он существует.

Прежде чем файл можно будет отправить в хранилище BLOB-объектов с помощью этого метода, его сначала необходимо преобразовать в поток байтов. Это продемонстрировано в следующем примере кода:

```csharp
var byteData = Encoding.UTF8.GetBytes(text);
uploadedFilename = await AzureStorage.UploadFileAsync(ContainerType.Text, new MemoryStream(byteData));
```

`text`Данные преобразуются в массив байтов, который затем упаковывается как поток, передаваемый в `UploadFileAsync` метод.

## <a name="downloading-data-from-a-container"></a>Загрузка данных из контейнера

`GetFileAsync`Метод используется для загрузки данных большого двоичного объекта из службы хранилища Azure и показан в следующем примере кода:

```csharp
public static async Task<byte[]> GetFileAsync(ContainerType containerType, string name)
{
  var container = GetContainer(containerType);

  var blob = container.GetBlobReference(name);
  if (await blob.ExistsAsync())
  {
    await blob.FetchAttributesAsync();
    byte[] blobBytes = new byte[blob.Properties.Length];

    await blob.DownloadToByteArrayAsync(blobBytes, 0);
    return blobBytes;
  }
  return null;
}
```

После получения ссылки на контейнер метод получает ссылку на большой двоичный объект для хранимых данных. Если большой двоичный объект существует, его свойства извлекаются `FetchAttributesAsync` методом. Создается массив байтов правильного размера, а большой двоичный объект загружается в виде массива байтов, возвращаемого вызывающему методу.

После скачивания байтовых данных большого двоичного объекта его необходимо преобразовать в исходное представление. Это продемонстрировано в следующем примере кода:

```csharp
var byteData = await AzureStorage.GetFileAsync(ContainerType.Text, uploadedFilename);
string text = Encoding.UTF8.GetString(byteData);
```

Массив байтов извлекается из службы хранилища Azure с помощью `GetFileAsync` метода перед преобразованием обратно в строку в кодировке UTF8.

## <a name="listing-data-in-a-container"></a>Перечисление данных в контейнере

`GetFilesListAsync`Метод используется для получения списка больших двоичных объектов, хранящихся в контейнере, и показан в следующем примере кода:

```csharp
public static async Task<IList<string>> GetFilesListAsync(ContainerType containerType)
{
  var container = GetContainer(containerType);

  var allBlobsList = new List<string>();
  BlobContinuationToken token = null;

  do
  {
    var result = await container.ListBlobsSegmentedAsync(token);
    if (result.Results.Count() > 0)
    {
      var blobs = result.Results.Cast<CloudBlockBlob>().Select(b => b.Name);
      allBlobsList.AddRange(blobs);
    }
    token = result.ContinuationToken;
  } while (token != null);

  return allBlobsList;
}
```

После получения ссылки на контейнер метод использует `ListBlobsSegmentedAsync` метод контейнера для получения ссылок на большие двоичные объекты в контейнере. Результаты, возвращаемые `ListBlobsSegmentedAsync` методом, перечисляются, а `BlobContinuationToken` экземпляр — нет `null` . Каждый большой двоичный объект приводится из возвращенного объекта в `IListBlobItem` `CloudBlockBlob` в порядке получения доступа к `Name` свойству большого двоичного объекта до того, как его значение добавляется в `allBlobsList` коллекцию. Когда `BlobContinuationToken` экземпляр равен `null` , возвращается Последнее имя большого двоичного объекта, а выполнение завершает цикл.

## <a name="deleting-data-from-a-container"></a>Удаление данных из контейнера

`DeleteFileAsync`Метод используется для удаления большого двоичного объекта из контейнера и показан в следующем примере кода:

```csharp
public static async Task<bool> DeleteFileAsync(ContainerType containerType, string name)
{
  var container = GetContainer(containerType);
  var blob = container.GetBlobReference(name);
  return await blob.DeleteIfExistsAsync();
}
```

После получения ссылки на контейнер метод получает ссылку на большой двоичный объект для указанного большого двоичного объекта. Затем большой двоичный объект удаляется с помощью `DeleteIfExistsAsync` метода.

## <a name="related-links"></a>Связанные ссылки

- [Служба хранилища Azure (пример)](/samples/xamarin/xamarin-forms-samples/webservices-azurestorage)
- [Общие сведения о хранилище](https://azure.microsoft.com/documentation/articles/storage-introduction/)
- [Как использовать хранилище BLOB-объектов из Xamarin](/azure/storage/blobs/storage-quickstart-blobs-xamarin)
- [Использование подписанных URL-адресов](/azure/storage/common/storage-sas-overview)
- [Хранилище Windows Azure (NuGet)](https://www.nuget.org/packages/WindowsAzure.Storage/)