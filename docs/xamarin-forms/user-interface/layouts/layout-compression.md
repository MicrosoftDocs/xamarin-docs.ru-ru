---
title: Сжатие макета
description: Сжатие макета удаляет указанные макеты из визуального дерева при попытке повысить производительность отрисовки страницы. В этой статье объясняется, как включить сжатие макета и преимущества, которые он может принести.
ms.prod: xamarin
ms.assetid: da9e1b26-9d31-4762-94c3-4039f306b7f2
ms.technology: xamarin-forms
author: davidbritch
ms.author: dabritch
ms.date: 12/13/2017
no-loc:
- Xamarin.Forms
- Xamarin.Essentials
ms.openlocfilehash: 9b22297fe06211b550ac2fdd62ee934b4ba849ee
ms.sourcegitcommit: 0a6b19004932c1ac82e16c95d5d3d5eb35a5b17f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/12/2021
ms.locfileid: "100255323"
---
# <a name="layout-compression"></a>Сжатие макета

[![Загрузить образец](~/media/shared/download.png) загрузить пример](/samples/xamarin/xamarin-forms-samples/userinterface-layoutcompression)

_Сжатие макета удаляет указанные макеты из визуального дерева при попытке повысить производительность отрисовки страницы. В этой статье объясняется, как включить сжатие макета и преимущества, которые он может принести._

## <a name="overview"></a>Обзор

Xamarin.Forms выполняет компоновку с помощью двух последовательных вызовов рекурсивных методов:

- Макет начинается в верхней части визуального дерева со страницей и проходит через все ветви визуального дерева, чтобы охватывать каждый визуальный элемент на странице. Элементы, являющиеся родительскими для других элементов, отвечают за изменение размера и размещение своих потомков относительно самих.
- Недействительность — это процесс, с помощью которого изменение элемента на странице вызывает новый цикл макета. Элементы считаются недопустимыми, если они больше не имеют нужного размера или расположения. Каждый элемент в визуальном дереве, имеющий дочерние элементы, оповещает каждый раз, когда изменяется размер одного из его дочерних элементов. Таким образом, изменение размера элемента в визуальном дереве может привести к изменению дерева.

Дополнительные сведения о том Xamarin.Forms , как работает макет, см. [в разделе Создание пользовательского макета](~/xamarin-forms/user-interface/layouts/custom.md).

Результатом процесса макета является иерархия собственных элементов управления. Однако эта иерархия включает дополнительные модули подготовки контейнеров и оболочки для модулей визуализации платформы, что еще больше увеличивает вложенность иерархии представления. Чем выше уровень вложенности, тем больше объем работы, который должен быть Xamarin.Forms выполнен для показа страницы. Для сложных макетов иерархия представлений может быть как глубиной, так и широкой, с несколькими уровнями вложенности.

Например, рассмотрим следующую кнопку из примера приложения для входа в Facebook:

![Кнопка Facebook](layout-compression-images/facebook-button.png)

Эта кнопка указана как пользовательский элемент управления со следующей иерархией представления XAML:

```xaml
<ContentView ...>
    <StackLayout>
        <StackLayout ...>
            <AbsoluteLayout ...>
                <Button ... />    
                <Image ... />
                <Image ... />
                <BoxView ... />
                <Label ... />
                <Button ... />
            </AbsoluteLayout>
        </StackLayout>
        <Label ... />
    </StackLayout>    
</ContentView>
```

Результирующую иерархию вложенных представлений можно исследовать с помощью динамического визуального дерева. В Android иерархия вложенных представлений содержит 17 представлений:

![Кнопка "Просмотреть иерархию" для Facebook](layout-compression-images/no-compression.png)

Сжатие макета, доступное для Xamarin.Forms приложений на платформах iOS и Android, нацелено на сведение вложений представления путем удаления указанных макетов из визуального дерева, что может повысить производительность отрисовки страниц. Предоставляемое преимущество производительности зависит от сложности страницы, используемой версии операционной системы и устройства, на котором выполняется приложение. Однако наиболее заметное повышение производительности будет наблюдаться на старых устройствах.

> [!NOTE]
> Хотя эта статья посвящена результатам применения сжатия макета в Android, она одинаково применима к iOS.

## <a name="layout-compression"></a>Сжатие макета

В XAML сжатие макета можно включить, задав `CompressedLayout.IsHeadless` для присоединенного свойства значение `true` в классе макета:

```xaml
<StackLayout CompressedLayout.IsHeadless="true">
  ...
</StackLayout>   
```

Кроме того, его можно включить в C#, указав экземпляр макета в качестве первого аргумента `CompressedLayout.SetIsHeadless` метода:

```csharp
CompressedLayout.SetIsHeadless(stackLayout, true);
```

> [!IMPORTANT]
> Так как сжатие макета удаляет макет из визуального дерева, оно не подходит для макетов, имеющих визуальный внешний вид, или для получения сенсорного ввода. Таким образом, макеты, которые задают [`VisualElement`](xref:Xamarin.Forms.VisualElement) Свойства (такие как,,, [`BackgroundColor`](xref:Xamarin.Forms.VisualElement.BackgroundColor) [`IsVisible`](xref:Xamarin.Forms.VisualElement.IsVisible) [`Rotation`](xref:Xamarin.Forms.VisualElement.Rotation) [`Scale`](xref:Xamarin.Forms.VisualElement.Scale) [`TranslationX`](xref:Xamarin.Forms.VisualElement.TranslationX) и [`TranslationY`](xref:Xamarin.Forms.VisualElement.TranslationY) или, принимают жесты), не являются кандидатами для сжатия макета. Однако включение сжатия макета для макета, устанавливающего свойства визуального представления или принимающего жесты, не приведет к возникновению ошибки сборки или среды выполнения. Вместо этого будет применено сжатие макета, а свойства визуального представления и распознавания жестов будут завершаться сбоем автоматически.

Для кнопки Facebook сжатие макета можно включить для трех классов макета:

```xaml
<StackLayout CompressedLayout.IsHeadless="true">
    <StackLayout CompressedLayout.IsHeadless="true" ...>
        <AbsoluteLayout CompressedLayout.IsHeadless="true" ...>
            ...
        </AbsoluteLayout>
    </StackLayout>
    ...
</StackLayout>  
```

В Android это приводит к вложенной иерархии представлений из 14 представлений:

![Просмотр иерархии для кнопки Facebook с сжатием макета](layout-compression-images/layout-compression.png)

По сравнению с исходной иерархией вложенного представления из 17 представлений это уменьшает число просмотров 17%. Хотя это снижение может оказаться несущественным, уменьшение представления по всей странице может быть более значительным.

### <a name="fast-renderers"></a>Быстрые отрисовщики

Быстрые модули подготовки к просмотру уменьшают расходы на инфляцию и отрисовку Xamarin.Forms элементов управления в Android за счет преобразования итоговой иерархии представления в собственную. Это повышает производительность за счет создания меньшего числа объектов, что, в свою очередь, приводит к менее сложному визуальному дереву и уменьшению использования памяти. Дополнительные сведения о быстрых модулях подготовки отчетов см. в разделе [быстрые модули подготовки](~/xamarin-forms/internals/fast-renderers.md)отчетов.

Для кнопки Facebook в примере приложения объединение сжатия макета и Экспресс-рендеринга создает вложенную иерархию представления из 8 представлений:

![Просмотр иерархии для кнопки Facebook с использованием сжатия макета и быстрых модулей подготовки отчетов](layout-compression-images/layout-compression-with-fast-renderers.png)

По сравнению с исходной иерархией вложенного представления из 17 представлений это значение представляет собой сокращение 52%.

Пример приложения содержит страницу, извлеченную из реального приложения. Без сжатия макета и быстрых модулей подготовки отчетов страница создает вложенную иерархию представлений 130 в Android. Включение быстрых модулей подготовки отчетов и сжатия макета в соответствующих классах макета сокращает иерархию вложенного представления до 70 просмотров, а также уменьшает значение 46%.

## <a name="summary"></a>Сводка

Сжатие макета удаляет указанные макеты из визуального дерева при попытке повысить производительность отрисовки страницы. В этом случае рост производительности зависит от сложности страницы, версии используемой операционной системы и устройства, на котором выполняется приложение. Однако наиболее заметное повышение производительности будет наблюдаться на старых устройствах.

## <a name="related-links"></a>Связанные ссылки

- [Создание пользовательского макета](~/xamarin-forms/user-interface/layouts/custom.md)
- [Быстрые отрисовщики](~/xamarin-forms/internals/fast-renderers.md)
- [Лайауткомпрессион (пример)](/samples/xamarin/xamarin-forms-samples/userinterface-layoutcompression)